<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard K√™nh B√°n 2025 - L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --bg-softer: #020617;
      --card: #111827;
      --card-soft: #020617;
      --primary: #38bdf8;
      --primary-soft: rgba(56, 189, 248, 0.12);
      --accent: #22c55e;
      --danger: #f97373;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --table-row: #020617;
      --table-row-alt: #020617;
      --chip-fb: #3b82f6;
      --chip-tt: #ec4899;
      --chip-sp: #f97316;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2933 0, #020617 52%);
      color: var(--text);
    }

    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.02em;
    }

    .title-block p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--muted);
    }

    .chip-target {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.4);
      font-size: 12px;
      color: var(--primary);
      white-space: nowrap;
    }

    .chip-target strong { color: var(--text); }

    .controls-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 12px;
      margin-bottom: 14px;
    }

    @media (max-width: 900px) {
      .controls-row { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: radial-gradient(circle at top left, #1f2937 0, #020617 60%);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      padding: 12px 12px 10px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 700px) {
      .filters-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
      color: var(--muted);
    }

    select,
    input[type="number"],
    input[type="text"] {
      background: #020617;
      border-radius: 9px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 6px 9px;
      color: var(--text);
      font-size: 12px;
      outline: none;
      width: 100%;
    }

    select:focus,
    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    .filters-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .input-search {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .input-search input { flex: 1; }

    .overview-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }

    @media (max-width: 900px) {
      .overview-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .overview-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .overview-card {
      background: radial-gradient(circle at top left, #020617 0, #020617 55%);
      border: 1px solid rgba(31, 41, 55, 1);
      border-radius: 14px;
      padding: 10px 10px 9px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.85);
    }

    .overview-label {
      font-size: 11px;
      color: var(--muted);
    }

    .overview-main {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 4px;
    }

    .overview-main strong {
      font-size: 16px;
      font-weight: 600;
    }

    .overview-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(55, 65, 81, 1);
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .badge-positive {
      border-color: rgba(34, 197, 94, 0.6);
      color: var(--accent);
      background: rgba(34, 197, 94, 0.12);
    }

    .badge-negative {
      border-color: rgba(248, 113, 113, 0.6);
      color: var(--danger);
      background: rgba(248, 113, 113, 0.12);
    }

    .table-section {
      background: linear-gradient(135deg, #020617 0, #020617 65%);
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 1);
      padding: 10px 10px 8px;
      margin-bottom: 14px;
      box-shadow: 0 18px 42px rgba(15, 23, 42, 0.9);
      position: relative;
      overflow: hidden;
    }

    .table-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .table-section-header h2 {
      margin: 0;
      font-size: 14px;
    }

    .table-hint {
      font-size: 11px;
      color: var(--muted);
    }

    .table-wrapper {
      overflow-x: auto;
      margin: 0 -4px;
      padding: 0 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 980px;
    }

    thead {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--muted);
      font-size: 10.5px;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.82);
    }

    tbody tr:nth-child(odd) {
      background: rgba(2, 6, 23, 0.9);
    }

    tbody tr:hover {
      background: rgba(15, 23, 42, 1);
    }

    .channel-name-cell {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .channel-name {
      font-size: 11.5px;
      font-weight: 500;
    }

    .channel-meta {
      font-size: 10px;
      color: var(--muted);
    }

    .platform-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 9.5px;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.85);
    }

    .platform-fb {
      border-color: rgba(59, 130, 246, 0.7);
      background: rgba(59, 130, 246, 0.12);
      color: #93c5fd;
    }

    .platform-tt {
      border-color: rgba(236, 72, 153, 0.7);
      background: rgba(236, 72, 153, 0.14);
      color: #f9a8d4;
    }

    .platform-sp {
      border-color: rgba(249, 115, 22, 0.7);
      background: rgba(249, 115, 22, 0.12);
      color: #fed7aa;
    }

    .type-chip {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 9.5px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.9);
    }

    .type-old {
      border-color: rgba(96, 165, 250, 0.65);
      background: rgba(59, 130, 246, 0.12);
      color: #bfdbfe;
    }

    .type-new {
      border-color: rgba(45, 212, 191, 0.65);
      background: rgba(45, 212, 191, 0.12);
      color: #a5f3fc;
    }

    .value-main {
      font-size: 11.5px;
      font-weight: 500;
    }

    .value-sub {
      font-size: 10px;
      color: var(--muted);
    }

    .trend-positive { color: var(--accent); }
    .trend-negative { color: var(--danger); }

    .percent-pill {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .percent-pill.good {
      border-color: rgba(34, 197, 94, 0.6);
      background: rgba(34, 197, 94, 0.14);
      color: var(--accent);
    }

    .percent-pill.bad {
      border-color: rgba(248, 113, 113, 0.7);
      background: rgba(248, 113, 113, 0.14);
      color: #f97373;
    }

    .btn-link {
      font-size: 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 3px 7px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--primary);
      cursor: pointer;
    }

    .btn-link:hover {
      border-color: rgba(56, 189, 248, 0.7);
      background: rgba(56, 189, 248, 0.12);
    }

    .editor-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.3fr;
      gap: 10px;
    }

    @media (max-width: 900px) {
      .editor-grid { grid-template-columns: minmax(0, 1fr); }
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 13px;
    }

    .card p {
      margin: 0 0 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .editor-form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 6px;
    }

    .editor-form-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 6px;
    }

    @media (max-width: 600px) {
      .editor-form-grid-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 11px;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #0b1120;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.4);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-0.5px);
    }

    .btn-ghost {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 4px 8px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      cursor: pointer;
    }

    .btn-ghost:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 360px;
      max-width: 100%;
      background: #020617;
      border-left: 1px solid rgba(31, 41, 55, 1);
      box-shadow: -18px 0 42px rgba(15, 23, 42, 0.95);
      padding: 10px 12px 16px;
      transform: translateX(100%);
      opacity: 0;
      transition: transform 0.22s ease-out, opacity 0.22s ease-out;
      z-index: 50;
      display: flex;
      flex-direction: column;
    }

    .drawer.open {
      transform: translateX(0);
      opacity: 1;
    }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .drawer-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .drawer-title-block h3 {
      margin: 0;
      font-size: 14px;
    }

    .drawer-title-block span {
      font-size: 11px;
      color: var(--muted);
    }

    .btn-icon {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.95);
      color: var(--muted);
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-icon:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .drawer-body {
      flex: 1;
      overflow: auto;
      padding-right: 2px;
    }

    .drawer-section-title {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin: 6px 0 4px;
    }

    .detail-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .detail-mini-card {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 1);
      background: rgba(15, 23, 42, 0.95);
      font-size: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 110px;
    }

    .detail-mini-card span:first-child {
      color: var(--muted);
      font-size: 10px;
    }

    .detail-mini-card strong {
      font-size: 11px;
    }

    .detail-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      margin-top: 4px;
      min-width: 580px;
    }

    .detail-table th,
    .detail-table td {
      border-bottom: 1px solid rgba(31, 41, 55, 1);
      padding: 4px 4px;
      text-align: left;
      white-space: nowrap;
    }

    .detail-table th {
      color: var(--muted);
      font-size: 9.5px;
    }

    .muted { color: var(--muted); }

    .note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Dashboard x√¢y d·ª±ng k√™nh b√°n 2025</h1>
      <p>Theo d√µi tƒÉng tr∆∞·ªüng k√™nh c≈© & m·ªü r·ªông k√™nh m·ªõi, b√°m m·ª•c ti√™u 1,36x.</p>
    </div>
    <div class="chip-target">
      üéØ M·ª•c ti√™u:
      <strong>+36%</strong>
      <span>doanh thu & ch·∫•t l∆∞·ª£ng k√™nh</span>
    </div>
  </header>

  <!-- FILTER + TARGET -->
  <div class="controls-row">
    <div class="card">
      <h2>B·ªô l·ªçc xem d·ªØ li·ªáu</h2>
      <div class="filters-grid">
        <div class="field">
          <label>NƒÉm</label>
          <select id="filterYear"></select>
        </div>
        <div class="field">
          <label>Th√°ng</label>
          <select id="filterMonth">
            <option value="1">Th√°ng 1</option>
            <option value="2">Th√°ng 2</option>
            <option value="3">Th√°ng 3</option>
            <option value="4">Th√°ng 4</option>
            <option value="5">Th√°ng 5</option>
            <option value="6">Th√°ng 6</option>
            <option value="7">Th√°ng 7</option>
            <option value="8">Th√°ng 8</option>
            <option value="9">Th√°ng 9</option>
            <option value="10">Th√°ng 10</option>
            <option value="11">Th√°ng 11</option>
            <option value="12">Th√°ng 12</option>
          </select>
        </div>
        <div class="field">
          <label>Hi·ªÉn th·ªã khung n·ªÅn t·∫£ng</label>
          <select id="filterPlatform">
            <option value="all">T·∫•t c·∫£</option>
            <option value="facebook">Ch·ªâ Facebook</option>
            <option value="tiktok">Ch·ªâ TikTok</option>
            <option value="shopee">Ch·ªâ Shopee</option>
          </select>
        </div>
        <div class="field">
          <label>Lo·∫°i k√™nh</label>
          <select id="filterType">
            <option value="all">T·∫•t c·∫£</option>
            <option value="old">K√™nh c≈©</option>
            <option value="new">K√™nh m·ªõi</option>
          </select>
        </div>
      </div>
      <div class="filters-inline">
        <div class="input-search">
          <span style="font-size:11px;color:var(--muted)">üîç</span>
          <input id="filterSearch" type="text" placeholder="T√¨m t√™n k√™nh..." />
        </div>
      </div>
    </div>

    <div class="card">
      <h2>
        M·ª•c ti√™u tƒÉng tr∆∞·ªüng 1,36x
        <button id="btnResetTargets" class="btn-ghost" type="button">Reset</button>
      </h2>
      <div class="filters-grid">
        <div class="field">
          <label>Doanh thu 2024 (g·ªëc)</label>
          <input id="baseRevenue2024" type="number" min="0" placeholder="VD: 150000000000" />
        </div>
        <div class="field">
          <label>Followers 2024 (g·ªëc)</label>
          <input id="baseFollowers2024" type="number" min="0" placeholder="VD: 2500000" />
        </div>
        <div class="field">
          <label>Target doanh thu 2025</label>
          <input id="targetRevenue2025" type="text" disabled />
        </div>
        <div class="field">
          <label>Target followers 2025</label>
          <input id="targetFollowers2025" type="text" disabled />
        </div>
      </div>
      <div class="note">
        H·ªá th·ªëng auto t√≠nh target 1,36x so v·ªõi 2024. Ph·∫ßn trƒÉm ho√†n th√†nh hi·ªÉn th·ªã ·ªü th·∫ª t·ªïng quan b√™n d∆∞·ªõi.
      </div>
    </div>
  </div>

  <!-- OVERVIEW -->
  <div class="overview-row">
    <div class="overview-card">
      <div class="overview-label">S·ªë l∆∞·ª£ng k√™nh (theo filter n·ªÅn t·∫£ng)</div>
      <div class="overview-main">
        <strong id="ovTotalChannels">0</strong>
        <span class="badge" id="ovChannelsSplit">C≈© 0 ¬∑ M·ªõi 0</span>
      </div>
      <div class="overview-sub">
        M·ª•c ti√™u k√™nh m·ªõi: <span id="ovNewChannelsGoal">+?</span>
      </div>
    </div>

    <div class="overview-card">
      <div class="overview-label">Doanh thu th√°ng (t·∫•t c·∫£ k√™nh trong filter)</div>
      <div class="overview-main">
        <strong id="ovRevenueMonth">0‚Ç´</strong>
        <span id="ovRevenueTrend" class="badge">So v·ªõi th√°ng tr∆∞·ªõc: 0%</span>
      </div>
      <div class="overview-sub">
        L≈©y k·∫ø nƒÉm: <span id="ovRevenueYTD">0‚Ç´</span>
      </div>
    </div>

    <div class="overview-card">
      <div class="overview-label">Followers (∆∞·ªõc t√≠nh)</div>
      <div class="overview-main">
        <strong id="ovFollowersTotal">0</strong>
        <span id="ovFollowersTrend" class="badge">So v·ªõi th√°ng tr∆∞·ªõc: 0%</span>
      </div>
      <div class="overview-sub">
        Ti·∫øn ƒë·ªô vs 2024 x1.36: <span id="ovFollowersProgress">0%</span>
      </div>
    </div>

    <div class="overview-card">
      <div class="overview-label">Ti·∫øn ƒë·ªô doanh thu vs target 2025</div>
      <div class="overview-main">
        <strong id="ovRevenueProgress">0%</strong>
        <span id="ovRevenueGap" class="badge">C√≤n thi·∫øu: 0‚Ç´</span>
      </div>
      <div class="overview-sub">
        D·ª±a tr√™n l≈©y k·∫ø doanh thu c√°c th√°ng trong nƒÉm ƒë∆∞·ª£c nh·∫≠p.
      </div>
    </div>
  </div>

  <!-- FB SECTION -->
  <section id="sectionFb" class="table-section">
    <div class="table-section-header">
      <h2>Facebook (Page & Group)</h2>
      <div class="table-hint">
        Nh·∫•p <span style="font-weight:600">Chi ti·∫øt</span> ƒë·ªÉ xem timeline t·ª´ng k√™nh.
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th style="min-width:190px;">K√™nh</th>
          <th>N·ªÅn t·∫£ng</th>
          <th>Lo·∫°i</th>
          <th>Doanh thu th√°ng</th>
          <th>So v·ªõi T-1</th>
          <th>Followers th√°ng</th>
          <th>User m·ªõi</th>
          <th>Video / Live / Post</th>
          <th>% ƒë·∫°t target doanh thu</th>
          <th>% ƒë·∫°t target followers</th>
          <th>Chi ti·∫øt</th>
        </tr>
        </thead>
        <tbody id="channelsTableBodyFb"></tbody>
      </table>
    </div>
  </section>

  <!-- TIKTOK SECTION -->
  <section id="sectionTt" class="table-section">
    <div class="table-section-header">
      <h2>TikTok</h2>
      <div class="table-hint">
        K√™nh video & live ‚Äì ƒëo ch·∫•t l∆∞·ª£ng n·ªôi dung theo s·ªë video/live/post.
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th style="min-width:190px;">K√™nh</th>
          <th>N·ªÅn t·∫£ng</th>
          <th>Lo·∫°i</th>
          <th>Doanh thu th√°ng</th>
          <th>So v·ªõi T-1</th>
          <th>Followers th√°ng</th>
          <th>User m·ªõi</th>
          <th>Video / Live / Post</th>
          <th>% ƒë·∫°t target doanh thu</th>
          <th>% ƒë·∫°t target followers</th>
          <th>Chi ti·∫øt</th>
        </tr>
        </thead>
        <tbody id="channelsTableBodyTt"></tbody>
      </table>
    </div>
  </section>

  <!-- SHOPEE SECTION -->
  <section id="sectionSp" class="table-section">
    <div class="table-section-header">
      <h2>Shopee</h2>
      <div class="table-hint">
        Gian h√†ng s√†n ‚Äì t·∫≠p trung conversion & doanh thu.
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th style="min-width:190px;">K√™nh</th>
          <th>N·ªÅn t·∫£ng</th>
          <th>Lo·∫°i</th>
          <th>Doanh thu th√°ng</th>
          <th>So v·ªõi T-1</th>
          <th>Followers th√°ng</th>
          <th>User m·ªõi</th>
          <th>Video / Live / Post</th>
          <th>% ƒë·∫°t target doanh thu</th>
          <th>% ƒë·∫°t target followers</th>
          <th>Chi ti·∫øt</th>
        </tr>
        </thead>
        <tbody id="channelsTableBodySp"></tbody>
      </table>
    </div>
  </section>

  <!-- FORMS -->
  <section class="editor-grid">
    <div class="card">
      <h3>Th√™m k√™nh m·ªõi</h3>
      <p>T·∫°o k√™nh m·ªõi (ƒë·∫∑c bi·ªát cho k·∫ø ho·∫°ch m·ªü r·ªông s·ªë l∆∞·ª£ng k√™nh nƒÉm 2025).</p>
      <form id="formAddChannel">
        <div class="editor-form-grid">
          <div class="field">
            <label>T√™n k√™nh</label>
            <input id="addChannelName" type="text" required placeholder="VD: TikTok - Velasboost Ch√≠nh" />
          </div>
          <div class="field">
            <label>N·ªÅn t·∫£ng</label>
            <select id="addChannelPlatform" required>
              <option value="">Ch·ªçn n·ªÅn t·∫£ng</option>
              <option value="facebook_page">Facebook Page</option>
              <option value="facebook_group">Facebook Group</option>
              <option value="tiktok">TikTok</option>
              <option value="shopee">Shopee</option>
            </select>
          </div>
        </div>
        <div class="editor-form-grid">
          <div class="field">
            <label>Lo·∫°i k√™nh</label>
            <select id="addChannelType" required>
              <option value="old">K√™nh c≈©</option>
              <option value="new">K√™nh m·ªõi</option>
            </select>
          </div>
          <div class="field">
            <label>Ghi ch√∫</label>
            <input id="addChannelNote" type="text" placeholder="VD: ∆Øu ti√™n x√¢y 2025 Q1" />
          </div>
        </div>
        <div class="editor-form-grid">
          <div class="field">
            <label>Target doanh thu / th√°ng (‚Ç´)</label>
            <input id="addChannelTargetRevenue" type="number" min="0" placeholder="VD: 200000000" />
          </div>
          <div class="field">
            <label>Target followers / th√°ng</label>
            <input id="addChannelTargetFollowers" type="number" min="0" placeholder="VD: 10000" />
          </div>
        </div>
        <button class="btn-primary" type="submit">‚ûï Th√™m k√™nh</button>
      </form>
      <div class="note" style="margin-top:6px;">
        Tip: T·∫°o tr∆∞·ªõc ƒë·∫ßy ƒë·ªß k√™nh Facebook / TikTok / Shopee, sau ƒë√≥ ch·ªâ vi·ªác nh·∫≠p s·ªë li·ªáu m·ªói th√°ng.
      </div>
    </div>

    <div class="card">
      <h3>Nh·∫≠p / c·∫≠p nh·∫≠t s·ªë li·ªáu theo th√°ng</h3>
      <p>M·ªói th√°ng, nh√¢n s·ª± ch·ªçn k√™nh & nh·∫≠p: doanh thu, followers, user m·ªõi, s·ªë video / live / post.</p>
      <form id="formUpdateMetrics">
        <div class="editor-form-grid-3">
          <div class="field">
            <label>Ch·ªçn k√™nh</label>
            <select id="metricsChannelSelect" required></select>
          </div>
          <div class="field">
            <label>NƒÉm</label>
            <select id="metricsYear" required></select>
          </div>
          <div class="field">
            <label>Th√°ng</label>
            <select id="metricsMonth" required>
              <option value="1">Th√°ng 1</option>
              <option value="2">Th√°ng 2</option>
              <option value="3">Th√°ng 3</option>
              <option value="4">Th√°ng 4</option>
              <option value="5">Th√°ng 5</option>
              <option value="6">Th√°ng 6</option>
              <option value="7">Th√°ng 7</option>
              <option value="8">Th√°ng 8</option>
              <option value="9">Th√°ng 9</option>
              <option value="10">Th√°ng 10</option>
              <option value="11">Th√°ng 11</option>
              <option value="12">Th√°ng 12</option>
            </select>
          </div>
        </div>

        <div class="editor-form-grid-3">
          <div class="field">
            <label>Doanh thu th√°ng (‚Ç´)</label>
            <input id="metricsRevenue" type="number" min="0" placeholder="VD: 600000000" required />
          </div>
          <div class="field">
            <label>T·ªïng followers cu·ªëi th√°ng</label>
            <input id="metricsFollowers" type="number" min="0" placeholder="VD: 150000" required />
          </div>
          <div class="field">
            <label>User m·ªõi trong th√°ng</label>
            <input id="metricsNewUsers" type="number" min="0" placeholder="VD: 12000" />
          </div>
        </div>

        <div class="editor-form-grid-3">
          <div class="field">
            <label>S·ªë video trong th√°ng</label>
            <input id="metricsVideos" type="number" min="0" placeholder="VD: 25" />
          </div>
          <div class="field">
            <label>S·ªë live trong th√°ng</label>
            <input id="metricsLives" type="number" min="0" placeholder="VD: 8" />
          </div>
          <div class="field">
            <label>S·ªë post / b√†i ƒëƒÉng</label>
            <input id="metricsPosts" type="number" min="0" placeholder="VD: 40" />
          </div>
        </div>

        <button class="btn-primary" type="submit">üíæ L∆∞u s·ªë li·ªáu th√°ng</button>
        <button class="btn-ghost" type="button" id="btnCopyFromPrev">‚è≠Ô∏è Copy t·ª´ th√°ng tr∆∞·ªõc</button>
      </form>

      <div style="margin-top:8px;border-top:1px dashed #1f2937;padding-top:6px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">
          T·ª± ƒë·ªông nh·∫≠p d·ªØ li·ªáu:
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;font-size:11px;">
          <input id="tiktokFileInput" type="file" accept=".csv" style="display:none;" />
          <button class="btn-ghost" type="button" id="btnImportTikTok">üì• Import file TikTok CSV</button>
          <button class="btn-ghost" type="button" id="btnSyncGoogleSheet">üîÑ ƒê·ªìng b·ªô t·ª´ Google Sheet</button>
        </div>
        <div class="note">
          File/Sheet n√™n c√≥ c·ªôt: <b>channel, platform, year, month, revenue, followers</b>  
          (t√πy ch·ªçn: <b>new_users, videos, lives, posts</b>). Tool s·∫Ω t·ª± map theo t√™n k√™nh + nƒÉm/th√°ng.
        </div>
      </div>
    </div>
  </section>
</div>

<!-- DRAWER -->
<div id="channelDrawer" class="drawer">
  <div class="drawer-header">
    <div class="drawer-title-block">
      <h3 id="drawerTitle">Chi ti·∫øt k√™nh</h3>
      <span id="drawerSubtitle"></span>
    </div>
    <button class="btn-icon" id="drawerCloseBtn" type="button">‚úï</button>
  </div>
  <div class="drawer-body">
    <div class="drawer-section-title">Th√¥ng tin t·ªïng quan</div>
    <div class="detail-meta-row">
      <div class="detail-mini-card">
        <span>N·ªÅn t·∫£ng</span>
        <strong id="drawerPlatform">-</strong>
      </div>
      <div class="detail-mini-card">
        <span>Lo·∫°i k√™nh</span>
        <strong id="drawerType">-</strong>
      </div>
      <div class="detail-mini-card">
        <span>Ghi ch√∫</span>
        <strong id="drawerNote">-</strong>
      </div>
    </div>

    <div class="drawer-section-title">D√≤ng ti·ªÅn, user & n·ªôi dung theo th√°ng</div>
    <table class="detail-table">
      <thead>
      <tr>
        <th>Th·ªùi gian</th>
        <th>Doanh thu</th>
        <th>Followers</th>
        <th>User m·ªõi</th>
        <th>Video</th>
        <th>Live</th>
        <th>Post</th>
        <th>% target DT</th>
        <th>% target F</th>
      </tr>
      </thead>
      <tbody id="drawerMetricsBody"></tbody>
    </table>

    <p class="note">
      Giai ƒëo·∫°n sau c√≥ th·ªÉ ƒë·∫•u n·ªëi Google Sheet / Form ƒë·ªÉ nh√¢n s·ª± nh·∫≠p s·ªë li·ªáu t·ª± ƒë·ªï v·ªÅ ƒë√¢y t·ª± ƒë·ªông.
    </p>
  </div>
</div>

<script>
  // ===== CONFIG GOOGLE SHEET =====
  const GOOGLE_SHEET_API_URL = ""; // ƒëi·ªÅn URL Apps Script n·∫øu d√πng

  const STORAGE_KEY = "nv_channel_dashboard_2025_v3";

  function createDefaultState() {
    return {
      settings: {
        baseRevenue2024: 150000000000,
        baseFollowers2024: 2500000,
        targetMultiplier: 1.36,
        newChannelsGoal: 5
      },
      channels: [
        {
          id: "fb_page_main",
          name: "Facebook Page - Velasboost Ch√≠nh",
          platform: "facebook_page",
          type: "old",
          note: "K√™nh tr·ª• c·ªôt traffic FB",
          targetMonthlyRevenue: 3000000000,
          targetMonthlyFollowers: 15000,
          metrics: {
            "2025-01": { revenue: 1800000000, followers: 800000, newUsers: 8000, videos: 20, lives: 0, posts: 60 },
            "2025-02": { revenue: 2200000000, followers: 820000, newUsers: 9000, videos: 18, lives: 0, posts: 55 }
          }
        },
        {
          id: "tt_main",
          name: "TikTok - Velasboost Official",
          platform: "tiktok",
          type: "old",
          note: "K√™nh TikTok ch√≠nh, ∆∞u ti√™n live & video",
          targetMonthlyRevenue: 4000000000,
          targetMonthlyFollowers: 20000,
          metrics: {
            "2025-01": { revenue: 2500000000, followers: 600000, newUsers: 15000, videos: 45, lives: 12, posts: 0 },
            "2025-02": { revenue: 3200000000, followers: 630000, newUsers: 16000, videos: 40, lives: 10, posts: 0 }
          }
        },
        {
          id: "sp_main",
          name: "Shopee - Velasboost Flagship",
          platform: "shopee",
          type: "old",
          note: "Gian h√†ng s√†n ch√≠nh",
          targetMonthlyRevenue: 5000000000,
          targetMonthlyFollowers: 12000,
          metrics: {
            "2025-01": { revenue: 3000000000, followers: 400000, newUsers: 10000, videos: 0, lives: 0, posts: 0 },
            "2025-02": { revenue: 3800000000, followers: 420000, newUsers: 11000, videos: 0, lives: 0, posts: 0 }
          }
        },
        {
          id: "tt_new_aff",
          name: "TikTok - K√™nh seller/affiliate 01",
          platform: "tiktok",
          type: "new",
          note: "K√™nh m·ªõi 2025, test n·ªôi dung b√°n l·ªó",
          targetMonthlyRevenue: 800000000,
          targetMonthlyFollowers: 5000,
          metrics: {
            "2025-02": { revenue: 300000000, followers: 20000, newUsers: 4000, videos: 25, lives: 5, posts: 0 }
          }
        }
      ]
    };
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return createDefaultState();
      const parsed = JSON.parse(raw);
      const def = createDefaultState();
      return {
        settings: Object.assign({}, def.settings, parsed.settings || {}),
        channels: parsed.channels || def.channels
      };
    } catch (e) {
      console.error("Load state l·ªói:", e);
      return createDefaultState();
    }
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.error("Save state l·ªói:", e);
    }
  }

  let state = loadState();

  // ===== UTILS =====
  function fmtCurrency(v) {
    if (v == null || isNaN(v)) return "-";
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
      maximumFractionDigits: 0
    }).format(v);
  }

  function fmtNumber(v) {
    if (v == null || isNaN(v)) return "-";
    return new Intl.NumberFormat("vi-VN").format(v);
  }

  function fmtPercent(v) {
    if (v == null || isNaN(v)) return "-";
    return v.toFixed(1) + "%";
  }

  function ymKey(year, month) {
    return year + "-" + String(month).padStart(2, "0");
  }

  function prevYM(year, month) {
    if (month > 1) return { year, month: month - 1 };
    return { year: year - 1, month: 12 };
  }

  function parseIntOrZero(v) {
    const n = parseInt(v, 10);
    return isNaN(n) ? 0 : n;
  }

  function mapPlatformLabel(platform) {
    switch (platform) {
      case "facebook_page": return "Facebook Page";
      case "facebook_group": return "Facebook Group";
      case "tiktok": return "TikTok";
      case "shopee": return "Shopee";
      default: return platform || "";
    }
  }

  function platformClass(platform) {
    if (platform === "facebook_page" || platform === "facebook_group")
      return "platform-fb";
    if (platform === "tiktok") return "platform-tt";
    if (platform === "shopee") return "platform-sp";
    return "";
  }

  function typeLabel(type) {
    return type === "new" ? "K√™nh m·ªõi" : "K√™nh c≈©";
  }

  function typeClass(type) {
    return type === "new" ? "type-new" : "type-old";
  }

  // ===== DOM =====
  const filterYearEl = document.getElementById("filterYear");
  const filterMonthEl = document.getElementById("filterMonth");
  const filterPlatformEl = document.getElementById("filterPlatform");
  const filterTypeEl = document.getElementById("filterType");
  const filterSearchEl = document.getElementById("filterSearch");

  const baseRevenueEl = document.getElementById("baseRevenue2024");
  const baseFollowersEl = document.getElementById("baseFollowers2024");
  const targetRevenueEl = document.getElementById("targetRevenue2025");
  const targetFollowersEl = document.getElementById("targetFollowers2025");
  const btnResetTargets = document.getElementById("btnResetTargets");

  const ovTotalChannelsEl = document.getElementById("ovTotalChannels");
  const ovChannelsSplitEl = document.getElementById("ovChannelsSplit");
  const ovNewChannelsGoalEl = document.getElementById("ovNewChannelsGoal");
  const ovRevenueMonthEl = document.getElementById("ovRevenueMonth");
  const ovRevenueTrendEl = document.getElementById("ovRevenueTrend");
  const ovRevenueYtdEl = document.getElementById("ovRevenueYTD");
  const ovFollowersTotalEl = document.getElementById("ovFollowersTotal");
  const ovFollowersTrendEl = document.getElementById("ovFollowersTrend");
  const ovFollowersProgressEl = document.getElementById("ovFollowersProgress");
  const ovRevenueProgressEl = document.getElementById("ovRevenueProgress");
  const ovRevenueGapEl = document.getElementById("ovRevenueGap");

  const tbodyFbEl = document.getElementById("channelsTableBodyFb");
  const tbodyTtEl = document.getElementById("channelsTableBodyTt");
  const tbodySpEl = document.getElementById("channelsTableBodySp");
  const sectionFbEl = document.getElementById("sectionFb");
  const sectionTtEl = document.getElementById("sectionTt");
  const sectionSpEl = document.getElementById("sectionSp");

  const formAddChannel = document.getElementById("formAddChannel");
  const addChannelNameEl = document.getElementById("addChannelName");
  const addChannelPlatformEl = document.getElementById("addChannelPlatform");
  const addChannelTypeEl = document.getElementById("addChannelType");
  const addChannelNoteEl = document.getElementById("addChannelNote");
  const addChannelTargetRevenueEl = document.getElementById("addChannelTargetRevenue");
  const addChannelTargetFollowersEl = document.getElementById("addChannelTargetFollowers");

  const formUpdateMetrics = document.getElementById("formUpdateMetrics");
  const metricsChannelSelectEl = document.getElementById("metricsChannelSelect");
  const metricsYearEl = document.getElementById("metricsYear");
  const metricsMonthEl = document.getElementById("metricsMonth");
  const metricsRevenueEl = document.getElementById("metricsRevenue");
  const metricsFollowersEl = document.getElementById("metricsFollowers");
  const metricsNewUsersEl = document.getElementById("metricsNewUsers");
  const metricsVideosEl = document.getElementById("metricsVideos");
  const metricsLivesEl = document.getElementById("metricsLives");
  const metricsPostsEl = document.getElementById("metricsPosts");
  const btnCopyFromPrev = document.getElementById("btnCopyFromPrev");

  const tiktokFileInputEl = document.getElementById("tiktokFileInput");
  const btnImportTikTokEl = document.getElementById("btnImportTikTok");
  const btnSyncGoogleSheetEl = document.getElementById("btnSyncGoogleSheet");

  const drawerEl = document.getElementById("channelDrawer");
  const drawerCloseBtn = document.getElementById("drawerCloseBtn");
  const drawerTitleEl = document.getElementById("drawerTitle");
  const drawerSubtitleEl = document.getElementById("drawerSubtitle");
  const drawerPlatformEl = document.getElementById("drawerPlatform");
  const drawerTypeEl = document.getElementById("drawerType");
  const drawerNoteEl = document.getElementById("drawerNote");
  const drawerMetricsBodyEl = document.getElementById("drawerMetricsBody");

  // Years
  const currentYear = 2025;
  const years = [2024, 2025, 2026];
  years.forEach((y) => {
    const opt1 = document.createElement("option");
    opt1.value = y;
    opt1.textContent = y;
    filterYearEl.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = y;
    opt2.textContent = y;
    metricsYearEl.appendChild(opt2);
  });
  filterYearEl.value = currentYear;
  metricsYearEl.value = currentYear;

  const now = new Date();
  filterMonthEl.value = String(now.getMonth() + 1);
  metricsMonthEl.value = String(now.getMonth() + 1);

  function refreshChannelSelectOptions() {
    metricsChannelSelectEl.innerHTML = "";
    state.channels.forEach((c) => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      metricsChannelSelectEl.appendChild(opt);
    });
  }
  refreshChannelSelectOptions();

  function updateTargetFields() {
    const baseRev = parseIntOrZero(baseRevenueEl.value);
    const baseFol = parseIntOrZero(baseFollowersEl.value);
    const mult = state.settings.targetMultiplier || 1.36;
    const targetRev = baseRev * mult;
    const targetFol = baseFol * mult;
    targetRevenueEl.value = targetRev ? fmtCurrency(targetRev) : "";
    targetFollowersEl.value = targetFol ? fmtNumber(targetFol) : "";
  }

  function applySettingsToInputs() {
    baseRevenueEl.value = state.settings.baseRevenue2024 || "";
    baseFollowersEl.value = state.settings.baseFollowers2024 || "";
    updateTargetFields();
  }
  applySettingsToInputs();

  baseRevenueEl.addEventListener("input", () => {
    state.settings.baseRevenue2024 = parseIntOrZero(baseRevenueEl.value);
    updateTargetFields();
    saveState();
    renderAll();
  });

  baseFollowersEl.addEventListener("input", () => {
    state.settings.baseFollowers2024 = parseIntOrZero(baseFollowersEl.value);
    updateTargetFields();
    saveState();
    renderAll();
  });

  btnResetTargets.addEventListener("click", () => {
    state.settings.baseRevenue2024 = 0;
    state.settings.baseFollowers2024 = 0;
    applySettingsToInputs();
    saveState();
    renderAll();
  });

  // AGGREGATES (theo filter n·ªÅn t·∫£ng)
  function computeAggregates(selectedYear, selectedMonth, platformFilter, typeFilter, searchText) {
    const key = ymKey(selectedYear, selectedMonth);
    const prev = prevYM(selectedYear, selectedMonth);
    const prevKey = ymKey(prev.year, prev.month);

    let totalRev = 0;
    let prevTotalRev = 0;
    let totalFollowers = 0;
    let prevTotalFollowers = 0;
    let totalRevYTD = 0;
    let channelCount = 0;
    let oldCount = 0;
    let newCount = 0;

    const matchPlatform = (c) => {
      if (platformFilter === "all") return true;
      if (platformFilter === "facebook")
        return c.platform === "facebook_page" || c.platform === "facebook_group";
      return c.platform === platformFilter;
    };

    state.channels.forEach((c) => {
      if (!matchPlatform(c)) return;
      if (typeFilter !== "all" && c.type !== typeFilter) return;
      if (searchText && !c.name.toLowerCase().includes(searchText)) return;

      channelCount++;
      if (c.type === "old") oldCount++; else newCount++;

      const m = c.metrics || {};
      const cur = m[key];
      const prevM = m[prevKey];

      if (cur) {
        totalRev += cur.revenue || 0;
        totalFollowers += cur.followers || 0;
      }
      if (prevM) {
        prevTotalRev += prevM.revenue || 0;
        prevTotalFollowers += prevM.followers || 0;
      }

      Object.keys(m).forEach((k) => {
        if (k.startsWith(String(selectedYear) + "-")) {
          totalRevYTD += m[k].revenue || 0;
        }
      });
    });

    const revChangePct =
      prevTotalRev > 0 ? ((totalRev - prevTotalRev) / prevTotalRev) * 100 : null;
    const folChangePct =
      prevTotalFollowers > 0
        ? ((totalFollowers - prevTotalFollowers) / prevTotalFollowers) * 100
        : null;

    return {
      totalRev,
      revChangePct,
      totalFollowers,
      folChangePct,
      totalRevYTD,
      channelCount,
      oldCount,
      newCount
    };
  }

  function renderOverview() {
    const selectedYear = parseInt(filterYearEl.value, 10);
    const selectedMonth = parseInt(filterMonthEl.value, 10);
    const platformFilter = filterPlatformEl.value;
    const typeFilter = filterTypeEl.value;
    const searchText = (filterSearchEl.value || "").toLowerCase().trim();

    const {
      totalRev,
      revChangePct,
      totalFollowers,
      folChangePct,
      totalRevYTD,
      channelCount,
      oldCount,
      newCount
    } = computeAggregates(selectedYear, selectedMonth, platformFilter, typeFilter, searchText);

    ovTotalChannelsEl.textContent = channelCount;
    ovChannelsSplitEl.textContent = `C≈© ${oldCount} ¬∑ M·ªõi ${newCount}`;

    const newGoal = state.settings.newChannelsGoal || 0;
    ovNewChannelsGoalEl.textContent = newGoal ? `+${newGoal} k√™nh` : "+? k√™nh";

    ovRevenueMonthEl.textContent = fmtCurrency(totalRev);
    ovRevenueYtdEl.textContent = fmtCurrency(totalRevYTD);

    ovRevenueTrendEl.textContent =
      revChangePct == null
        ? "So v·ªõi th√°ng tr∆∞·ªõc: ---"
        : `So v·ªõi th√°ng tr∆∞·ªõc: ${revChangePct >= 0 ? "+" : ""}${revChangePct.toFixed(1)}%`;
    ovRevenueTrendEl.classList.remove("badge-positive", "badge-negative");
    if (revChangePct != null) {
      ovRevenueTrendEl.classList.add(
        revChangePct >= 0 ? "badge-positive" : "badge-negative"
      );
    }

    ovFollowersTotalEl.textContent = fmtNumber(totalFollowers);
    ovFollowersTrendEl.textContent =
      folChangePct == null
        ? "So v·ªõi th√°ng tr∆∞·ªõc: ---"
        : `So v·ªõi th√°ng tr∆∞·ªõc: ${folChangePct >= 0 ? "+" : ""}${folChangePct.toFixed(1)}%`;
    ovFollowersTrendEl.classList.remove("badge-positive", "badge-negative");
    if (folChangePct != null) {
      ovFollowersTrendEl.classList.add(
        folChangePct >= 0 ? "badge-positive" : "badge-negative"
      );
    }

    const baseRev = state.settings.baseRevenue2024 || 0;
    const baseFol = state.settings.baseFollowers2024 || 0;
    const mult = state.settings.targetMultiplier || 1.36;
    const targetRev = baseRev * mult;
    const targetFol = baseFol * mult;

    if (targetRev > 0) {
      const progress = Math.min((totalRevYTD / targetRev) * 100, 999);
      ovRevenueProgressEl.textContent = progress.toFixed(1) + "%";
      const gap = targetRev - totalRevYTD;
      ovRevenueGapEl.textContent =
        "C√≤n thi·∫øu: " + (gap > 0 ? fmtCurrency(gap) : "ƒê√£ v∆∞·ª£t target");
    } else {
      ovRevenueProgressEl.textContent = "0%";
      ovRevenueGapEl.textContent = "C√≤n thi·∫øu: 0‚Ç´";
    }

    if (targetFol > 0) {
      const folProg = Math.min((totalFollowers / targetFol) * 100, 999);
      ovFollowersProgressEl.textContent = folProg.toFixed(1) + "%";
    } else {
      ovFollowersProgressEl.textContent = "0%";
    }
  }

  function renderChannelsTable() {
    const year = parseInt(filterYearEl.value, 10);
    const month = parseInt(filterMonthEl.value, 10);
    const key = ymKey(year, month);
    const prev = prevYM(year, month);
    const prevKey = ymKey(prev.year, prev.month);

    const platformFilter = filterPlatformEl.value;
    const typeFilter = filterTypeEl.value;
    const search = (filterSearchEl.value || "").toLowerCase().trim();

    // clear bodies
    tbodyFbEl.innerHTML = "";
    tbodyTtEl.innerHTML = "";
    tbodySpEl.innerHTML = "";

    let fbHas = false, ttHas = false, spHas = false;

    const matchPlatformFilter = (c) => {
      if (platformFilter === "all") return true;
      if (platformFilter === "facebook")
        return c.platform === "facebook_page" || c.platform === "facebook_group";
      return c.platform === platformFilter;
    };

    state.channels.forEach((c) => {
      if (!matchPlatformFilter(c)) return;
      if (typeFilter !== "all" && c.type !== typeFilter) return;
      if (search && !c.name.toLowerCase().includes(search)) return;

      const metrics = c.metrics || {};
      const cur = metrics[key] || {};
      const prevM = metrics[prevKey] || {};
      const curRev = cur.revenue || 0;
      const prevRev = prevM.revenue || 0;
      const curFol = cur.followers || 0;
      const prevFol = prevM.followers || 0;
      const curNewUsers = cur.newUsers || 0;
      const curVideos = cur.videos || 0;
      const curLives = cur.lives || 0;
      const curPosts = cur.posts || 0;

      const revDiff = prevRev ? curRev - prevRev : null;
      const revPct = prevRev > 0 ? ((curRev - prevRev) / prevRev) * 100 : null;
      const folDiff = prevFol ? curFol - prevFol : null;

      const targetRev = c.targetMonthlyRevenue || 0;
      const targetFol = c.targetMonthlyFollowers || 0;
      const pctToTargetRev = targetRev > 0 ? (curRev / targetRev) * 100 : null;
      const pctToTargetFol = targetFol > 0 ? (curFol / targetFol) * 100 : null;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div class="channel-name-cell">
            <span class="channel-name">${c.name}</span>
            <span class="channel-meta">${c.note || ""}</span>
          </div>
        </td>
        <td>
          <span class="platform-chip ${platformClass(c.platform)}">
            ${mapPlatformLabel(c.platform)}
          </span>
        </td>
        <td>
          <span class="type-chip ${typeClass(c.type)}">${typeLabel(c.type)}</span>
        </td>
        <td>
          <div class="value-main">${fmtCurrency(curRev)}</div>
          <div class="value-sub">${targetRev ? `Target: ${fmtCurrency(targetRev)}` : ""}</div>
        </td>
        <td>
          ${
            revDiff == null
              ? '<span class="value-sub">Ch∆∞a c√≥ d·ªØ li·ªáu T-1</span>'
              : `
            <div class="value-main ${revDiff >= 0 ? "trend-positive" : "trend-negative"}">
              ${revDiff >= 0 ? "+" : ""}${fmtCurrency(revDiff)}
            </div>
            <div class="value-sub ${revDiff >= 0 ? "trend-positive" : "trend-negative"}">
              ${revPct >= 0 ? "+" : ""}${revPct.toFixed(1)}%
            </div>
          `
          }
        </td>
        <td>
          <div class="value-main">${fmtNumber(curFol)}</div>
          <div class="value-sub">${targetFol ? `Target: ${fmtNumber(targetFol)}` : ""}</div>
        </td>
        <td>
          <div class="value-main">${fmtNumber(curNewUsers)}</div>
          <div class="value-sub">So v·ªõi cu·ªëi T-1: ${
            folDiff == null ? "---" : (folDiff >= 0 ? "+" : "") + fmtNumber(folDiff)
          }</div>
        </td>
        <td>
          <div class="value-main">
            ${fmtNumber(curVideos)}v ¬∑ ${fmtNumber(curLives)} live
          </div>
          <div class="value-sub">
            ${fmtNumber(curPosts)} post
          </div>
        </td>
        <td>
          ${
            pctToTargetRev == null
              ? '<span class="value-sub">Ch∆∞a ƒë·∫∑t target</span>'
              : `<span class="percent-pill ${pctToTargetRev >= 100 ? "good" : ""}">
                  ${fmtPercent(pctToTargetRev)}
                 </span>`
          }
        </td>
        <td>
          ${
            pctToTargetFol == null
              ? '<span class="value-sub">Ch∆∞a ƒë·∫∑t target</span>'
              : `<span class="percent-pill ${pctToTargetFol >= 100 ? "good" : ""}">
                  ${fmtPercent(pctToTargetFol)}
                 </span>`
          }
        </td>
        <td>
          <button class="btn-link" type="button" data-channel-id="${c.id}">Chi ti·∫øt</button>
        </td>
      `;

      if (c.platform === "tiktok") {
        tbodyTtEl.appendChild(tr);
        ttHas = true;
      } else if (c.platform === "shopee") {
        tbodySpEl.appendChild(tr);
        spHas = true;
      } else {
        tbodyFbEl.appendChild(tr);
        fbHas = true;
      }
    });

    sectionFbEl.style.display = fbHas ? "block" : "none";
    sectionTtEl.style.display = ttHas ? "block" : "none";
    sectionSpEl.style.display = spHas ? "block" : "none";

    document.querySelectorAll("button[data-channel-id]").forEach((btn) => {
      btn.onclick = () => {
        const id = btn.getAttribute("data-channel-id");
        openChannelDrawer(id);
      };
    });
  }

  function renderAll() {
    renderOverview();
    renderChannelsTable();
  }

  // ===== FORMS =====
  formAddChannel.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = addChannelNameEl.value.trim();
    const platform = addChannelPlatformEl.value;
    const type = addChannelTypeEl.value;
    if (!name || !platform || !type) return;

    const note = addChannelNoteEl.value.trim();
    const targetRevenue = parseIntOrZero(addChannelTargetRevenueEl.value);
    const targetFollowers = parseIntOrZero(addChannelTargetFollowersEl.value);

    const id =
      platform +
      "_" +
      type +
      "_" +
      name.toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_]/g, "") +
      "_" +
      Date.now();

    state.channels.push({
      id,
      name,
      platform,
      type,
      note,
      targetMonthlyRevenue: targetRevenue || 0,
      targetMonthlyFollowers: targetFollowers || 0,
      metrics: {}
    });

    saveState();
    refreshChannelSelectOptions();
    renderAll();

    formAddChannel.reset();
    addChannelPlatformEl.value = "";
    addChannelTypeEl.value = "new";
  });

  formUpdateMetrics.addEventListener("submit", (e) => {
    e.preventDefault();
    const channelId = metricsChannelSelectEl.value;
    const year = parseInt(metricsYearEl.value, 10);
    const month = parseInt(metricsMonthEl.value, 10);
    const key = ymKey(year, month);

    const revenue = parseIntOrZero(metricsRevenueEl.value);
    const followers = parseIntOrZero(metricsFollowersEl.value);
    const newUsers = parseIntOrZero(metricsNewUsersEl.value);
    const videos = parseIntOrZero(metricsVideosEl.value);
    const lives = parseIntOrZero(metricsLivesEl.value);
    const posts = parseIntOrZero(metricsPostsEl.value);

    const c = state.channels.find((ch) => ch.id === channelId);
    if (!c) return;

    if (!c.metrics) c.metrics = {};
    c.metrics[key] = {
      revenue,
      followers,
      newUsers,
      videos,
      lives,
      posts
    };

    saveState();
    renderAll();
  });

  btnCopyFromPrev.addEventListener("click", () => {
    const channelId = metricsChannelSelectEl.value;
    const year = parseInt(metricsYearEl.value, 10);
    const month = parseInt(metricsMonthEl.value, 10);
    const prev = prevYM(year, month);
    const prevKey = ymKey(prev.year, prev.month);

    const c = state.channels.find((ch) => ch.id === channelId);
    if (!c || !c.metrics) return;

    const prevM = c.metrics[prevKey];
    if (!prevM) return;

    metricsRevenueEl.value = prevM.revenue || "";
    metricsFollowersEl.value = prevM.followers || "";
    metricsNewUsersEl.value = prevM.newUsers || "";
    metricsVideosEl.value = prevM.videos || "";
    metricsLivesEl.value = prevM.lives || "";
    metricsPostsEl.value = prevM.posts || "";
  });

  [filterYearEl, filterMonthEl, filterPlatformEl, filterTypeEl].forEach((el) => {
    el.addEventListener("change", renderAll);
  });
  filterSearchEl.addEventListener("input", renderAll);

  // ===== DRAWER =====
  function openChannelDrawer(channelId) {
    const c = state.channels.find((ch) => ch.id === channelId);
    if (!c) return;

    drawerTitleEl.textContent = c.name;
    drawerSubtitleEl.textContent = `${mapPlatformLabel(c.platform)} ¬∑ ${typeLabel(c.type)}`;
    drawerPlatformEl.textContent = mapPlatformLabel(c.platform);
    drawerTypeEl.textContent = typeLabel(c.type);
    drawerNoteEl.textContent = c.note || "-";

    const targetRev = c.targetMonthlyRevenue || 0;
    const targetFol = c.targetMonthlyFollowers || 0;

    const rows = [];
    const keys = Object.keys(c.metrics || {}).sort();
    keys.forEach((k) => {
      const m = c.metrics[k];
      if (!m) return;
      const [y, mth] = k.split("-");
      const label = `T${parseInt(mth, 10)}/${y}`;
      const pctRev = targetRev ? (m.revenue / targetRev) * 100 : null;
      const pctFol = targetFol ? (m.followers / targetFol) * 100 : null;
      rows.push(`
        <tr>
          <td>${label}</td>
          <td>${fmtCurrency(m.revenue)}</td>
          <td>${fmtNumber(m.followers)}</td>
          <td>${fmtNumber(m.newUsers || 0)}</td>
          <td>${fmtNumber(m.videos || 0)}</td>
          <td>${fmtNumber(m.lives || 0)}</td>
          <td>${fmtNumber(m.posts || 0)}</td>
          <td>${pctRev == null ? "-" : fmtPercent(pctRev)}</td>
          <td>${pctFol == null ? "-" : fmtPercent(pctFol)}</td>
        </tr>
      `);
    });

    drawerMetricsBodyEl.innerHTML =
      rows.length > 0
        ? rows.join("")
        : `<tr><td colspan="9" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu th√°ng n√†o cho k√™nh n√†y.</td></tr>`;

    drawerEl.classList.add("open");
  }

  drawerCloseBtn.addEventListener("click", () => {
    drawerEl.classList.remove("open");
  });

  // ===== IMPORT CSV TIKTOK =====
  function parseCsvToRows(text) {
    const lines = text.split(/\r?\n/).map((l) => l.trim()).filter((l) => l);
    if (!lines.length) return [];
    const headers = lines[0].split(",").map((h) => h.trim().toLowerCase());
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = (cols[idx] || "").trim();
      });
      rows.push(row);
    }
    return rows;
  }

  function normalizeRow(row) {
    const lower = {};
    Object.keys(row).forEach((k) => {
      lower[k.toLowerCase()] = row[k];
    });
    const get = (...keys) => {
      for (const k of keys) {
        if (lower[k] != null && lower[k] !== "") return lower[k];
      }
      return "";
    };

    return {
      channel: get("channel", "channel_name", "kenh"),
      platform: get("platform") || "tiktok",
      type: get("type") || "new",
      note: get("note") || "",
      year: parseInt(get("year"), 10),
      month: parseInt(get("month"), 10),
      revenue: parseIntOrZero(get("revenue", "doanhthu")),
      followers: parseIntOrZero(get("followers", "follower")),
      new_users: parseIntOrZero(get("new_users", "newusers", "user_moi")),
      videos: parseIntOrZero(get("videos", "video")),
      lives: parseIntOrZero(get("lives", "live")),
      posts: parseIntOrZero(get("posts", "post", "bai_dang")),
      targetMonthlyRevenue: parseIntOrZero(get("target_monthly_revenue")),
      targetMonthlyFollowers: parseIntOrZero(get("target_monthly_followers"))
    };
  }

  function importRows(rows, sourceLabel) {
    let imported = 0;
    rows.forEach((raw) => {
      const r = normalizeRow(raw);
      if (!r.channel || !r.year || !r.month) return;
      const key = ymKey(r.year, r.month);

      let c = state.channels.find((ch) => ch.name === r.channel);
      if (!c) {
        c = {
          id: "import_" + Date.now() + "_" + Math.random().toString(36).slice(2, 7),
          name: r.channel,
          platform: r.platform || "tiktok",
          type: r.type === "old" ? "old" : "new",
          note: r.note || `Import t·ª´ ${sourceLabel}`,
          targetMonthlyRevenue: r.targetMonthlyRevenue || 0,
          targetMonthlyFollowers: r.targetMonthlyFollowers || 0,
          metrics: {}
        };
        state.channels.push(c);
      }
      if (!c.metrics) c.metrics = {};
      c.metrics[key] = {
        revenue: r.revenue,
        followers: r.followers,
        newUsers: r.new_users,
        videos: r.videos,
        lives: r.lives,
        posts: r.posts
      };
      imported++;
    });

    if (imported > 0) {
      saveState();
      refreshChannelSelectOptions();
      renderAll();
      alert(`ƒê√£ import ${imported} d√≤ng t·ª´ ${sourceLabel}.`);
    } else {
      alert(`Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá trong d·ªØ li·ªáu ${sourceLabel}.`);
    }
  }

  function handleTikTokFile(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const text = evt.target.result;
        const rows = parseCsvToRows(text);
        importRows(rows, "file TikTok CSV");
      } catch (err) {
        console.error(err);
        alert("L·ªói ƒë·ªçc file CSV TikTok. Ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng.");
      } finally {
        tiktokFileInputEl.value = "";
      }
    };
    reader.readAsText(file, "utf-8");
  }

  btnImportTikTokEl.addEventListener("click", () => {
    tiktokFileInputEl.click();
  });

  tiktokFileInputEl.addEventListener("change", handleTikTokFile);

  async function syncFromGoogleSheet() {
    if (!GOOGLE_SHEET_API_URL) {
      alert("Ch∆∞a c·∫•u h√¨nh GOOGLE_SHEET_API_URL trong code.");
      return;
    }
    try {
      const res = await fetch(GOOGLE_SHEET_API_URL);
      const data = await res.json();
      if (!Array.isArray(data)) {
        alert("D·ªØ li·ªáu Google Sheet kh√¥ng ph·∫£i d·∫°ng m·∫£ng JSON.");
        return;
      }
      importRows(data, "Google Sheet");
    } catch (err) {
      console.error(err);
      alert("L·ªói ƒë·ªìng b·ªô Google Sheet. Ki·ªÉm tra l·∫°i URL / Apps Script.");
    }
  }

  btnSyncGoogleSheetEl.addEventListener("click", syncFromGoogleSheet);

  // FIRST RENDER
  renderAll();
</script>
</body>
</html>
